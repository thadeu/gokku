#!/bin/bash
SERVICE_NAME="$1"

echo "-----> Installing Cron service: $SERVICE_NAME"

# Source helper functions
source /opt/gokku/scripts/plugin-helpers.sh

# Create service directory
SERVICE_DIR=$(create_service_dir "$SERVICE_NAME")
mkdir -p "$SERVICE_DIR/jobs"
mkdir -p "$SERVICE_DIR/logs"

# Create cron configuration directory
mkdir -p "$SERVICE_DIR/crontabs"

# Create default crontab file
cat > "$SERVICE_DIR/crontabs/root" << 'EOF'
# Gokku Cron Jobs
# Edit this file to add scheduled tasks
# Format: minute hour day month weekday command
#
# Examples:
# 0 22 * * * /opt/gokku/scripts/run-cron-job.sh backup-redis-daily
# 0 */6 * * * /opt/gokku/scripts/run-cron-job.sh cleanup-logs
# 30 2 * * 0 /opt/gokku/scripts/run-cron-job.sh weekly-backup

EOF

# Create job runner script
cat > "$SERVICE_DIR/run-job.sh" << 'EOF'
#!/bin/bash
JOB_NAME="$1"
JOB_COMMAND="$2"
SERVICE_NAME="$3"
LOG_DIR="/opt/gokku/services/$SERVICE_NAME/logs"

# Create log file with timestamp
LOG_FILE="$LOG_DIR/${JOB_NAME}_$(date +%Y%m%d_%H%M%S).log"

# Run the command and log output
{
    echo "Job: $JOB_NAME"
    echo "Command: $JOB_COMMAND"
    echo "Started: $(date)"
    echo "----------------------------------------"

    # Execute the command
    eval "$JOB_COMMAND"

    echo "----------------------------------------"
    echo "Completed: $(date)"
    echo "Exit code: $?"
} >> "$LOG_FILE" 2>&1

# Keep only last 100 log files per job
find "$LOG_DIR" -name "${JOB_NAME}_*.log" | sort | head -n -100 | xargs rm -f 2>/dev/null || true
EOF

chmod +x "$SERVICE_DIR/run-job.sh"

# Create cron container
docker run -d \
  --name "$SERVICE_NAME" \
  -v "$SERVICE_DIR/crontabs:/var/spool/cron/crontabs:ro" \
  -v "$SERVICE_DIR/run-job.sh:/opt/run-job.sh:ro" \
  -v "$SERVICE_DIR/logs:/var/log/cron" \
  -v "/opt/gokku:/opt/gokku:ro" \
  --restart unless-stopped \
  alpine:latest \
  sh -c "
    apk add --no-cache dcron && \
    mkdir -p /var/log/cron && \
    touch /var/log/cron/cron.log && \
    crond -f -l 2
  "

# Wait for container to be ready
wait_for_container "$SERVICE_NAME"

# Update service configuration
update_service_config "$SERVICE_NAME" "service_dir" "$SERVICE_DIR"
update_service_config "$SERVICE_NAME" "jobs_dir" "$SERVICE_DIR/jobs"
update_service_config "$SERVICE_NAME" "logs_dir" "$SERVICE_DIR/logs"

echo "-----> Cron service installed successfully"
echo "       Jobs directory: $SERVICE_DIR/jobs"
echo "       Logs directory: $SERVICE_DIR/logs"
echo "       Crontab file: $SERVICE_DIR/crontabs/root"
