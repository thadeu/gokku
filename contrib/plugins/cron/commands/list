#!/bin/bash
SERVICE_NAME="$1"

echo "Scheduled jobs for $SERVICE_NAME:"
echo "================================="

# Source helper functions
source /opt/gokku/scripts/plugin-helpers.sh

# Check if container exists
if ! container_exists "$SERVICE_NAME"; then
    echo "Service '$SERVICE_NAME' not found"
    exit 1
fi

# Get service directories
SERVICE_DIR=$(get_service_config "$SERVICE_NAME" | grep -o '"service_dir":"[^"]*"' | cut -d'"' -f4)
JOBS_DIR=$(get_service_config "$SERVICE_NAME" | grep -o '"jobs_dir":"[^"]*"' | cut -d'"' -f4)
CRONTAB_FILE="$SERVICE_DIR/crontabs/root"

if [ ! -d "$JOBS_DIR" ]; then
    echo "Jobs directory not found"
    exit 1
fi

# List job files
JOB_FILES=$(find "$JOBS_DIR" -name "*.job" | sort)

if [ -z "$JOB_FILES" ]; then
    echo "No scheduled jobs found"
    exit 0
fi

echo "Job Name          | Schedule      | Command"
echo "------------------|---------------|----------------------------------------"

for job_file in $JOB_FILES; do
    if [ -f "$job_file" ]; then
        # Source the job file to get variables
        source "$job_file"

        # Get cron schedule from crontab
        CRON_SCHEDULE=$(grep "JOB_NAME=$JOB_NAME" "$CRONTAB_FILE" 2>/dev/null | awk '{print $1, $2, $3, $4, $5}')

        # Truncate command if too long
        TRUNCATED_COMMAND="$JOB_COMMAND"
        if [ ${#TRUNCATED_COMMAND} -gt 40 ]; then
            TRUNCATED_COMMAND="${TRUNCATED_COMMAND:0:37}..."
        fi

        printf "%-17s | %-13s | %s\n" "$JOB_NAME" "$CRON_SCHEDULE" "$TRUNCATED_COMMAND"
    fi
done

echo ""
echo "Use 'gokku cron:logs-job <service> <job-name>' to view job execution logs"
