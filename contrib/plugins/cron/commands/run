#!/bin/bash
SERVICE_NAME="$1"
JOB_NAME="$2"

echo "-----> Running job '$JOB_NAME' in $SERVICE_NAME"

# Source helper functions
source /opt/gokku/scripts/plugin-helpers.sh

# Check if container exists
if ! container_exists "$SERVICE_NAME"; then
    echo "Service '$SERVICE_NAME' not found"
    exit 1
fi

# Check if container is running
if ! container_is_running "$SERVICE_NAME"; then
    echo "Service '$SERVICE_NAME' is not running"
    exit 1
fi

# Validate parameters
if [ -z "$JOB_NAME" ]; then
    echo "Usage: gokku cron:run <service> <job-name>"
    echo "Example: gokku cron:run cron-scheduler backup-redis"
    exit 1
fi

# Get service directories
SERVICE_DIR=$(get_service_config "$SERVICE_NAME" | grep -o '"service_dir":"[^"]*"' | cut -d'"' -f4)
JOBS_DIR=$(get_service_config "$SERVICE_NAME" | grep -o '"jobs_dir":"[^"]*"' | cut -d'"' -f4)

if [ ! -d "$JOBS_DIR" ]; then
    echo "Jobs directory not found"
    exit 1
fi

# Check if job exists
JOB_FILE="$JOBS_DIR/${JOB_NAME}.job"
if [ ! -f "$JOB_FILE" ]; then
    echo "Job '$JOB_NAME' not found"
    exit 1
fi

# Source the job file to get variables
source "$JOB_FILE"

echo "-----> Executing job: $JOB_NAME"
echo "       Command: $JOB_COMMAND"

# Run the job script
docker exec "$SERVICE_NAME" /opt/run-job.sh "$JOB_NAME" "$JOB_COMMAND" "$SERVICE_NAME"

echo "-----> Job execution completed"
echo "       Check logs with: gokku cron:logs-job $SERVICE_NAME $JOB_NAME"
