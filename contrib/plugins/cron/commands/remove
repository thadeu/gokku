#!/bin/bash
SERVICE_NAME="$1"
JOB_NAME="$2"

echo "-----> Removing job '$JOB_NAME' from $SERVICE_NAME"

# Source helper functions
source /opt/gokku/scripts/plugin-helpers.sh

# Check if container exists
if ! container_exists "$SERVICE_NAME"; then
    echo "Service '$SERVICE_NAME' not found"
    exit 1
fi

# Validate parameters
if [ -z "$JOB_NAME" ]; then
    echo "Usage: gokku cron:remove <service> <job-name>"
    echo "Example: gokku cron:remove cron-scheduler backup-redis"
    exit 1
fi

# Get service directories
SERVICE_DIR=$(get_service_config "$SERVICE_NAME" | grep -o '"service_dir":"[^"]*"' | cut -d'"' -f4)
JOBS_DIR=$(get_service_config "$SERVICE_NAME" | grep -o '"jobs_dir":"[^"]*"' | cut -d'"' -f4)
CRONTAB_FILE="$SERVICE_DIR/crontabs/root"

if [ ! -d "$JOBS_DIR" ]; then
    echo "Jobs directory not found"
    exit 1
fi

# Check if job exists
JOB_FILE="$JOBS_DIR/${JOB_NAME}.job"
if [ ! -f "$JOB_FILE" ]; then
    echo "Job '$JOB_NAME' not found"
    exit 1
fi

# Remove from crontab
if grep -q "JOB_NAME=$JOB_NAME" "$CRONTAB_FILE" 2>/dev/null; then
    grep -v "JOB_NAME=$JOB_NAME" "$CRONTAB_FILE" > "$CRONTAB_FILE.tmp" 2>/dev/null || true
    mv "$CRONTAB_FILE.tmp" "$CRONTAB_FILE"
    echo "-----> Job removed from crontab"
else
    echo "Job not found in crontab"
fi

# Remove job file
rm -f "$JOB_FILE"
echo "-----> Job file removed"

echo "-----> Job '$JOB_NAME' removed successfully"
