#!/bin/bash
SERVICE_NAME="$1"
BACKUP_FILE="$2"

# Source helper functions
source /opt/gokku/scripts/plugin-helpers.sh

# Check if container exists
if ! container_exists "$SERVICE_NAME"; then
    echo "Service '$SERVICE_NAME' not found"
    exit 1
fi

# Check if container is running
if ! container_is_running "$SERVICE_NAME"; then
    echo "Service '$SERVICE_NAME' is not running"
    exit 1
fi

# Check if backup file exists
if [ ! -f "$BACKUP_FILE" ]; then
    echo "Backup file '$BACKUP_FILE' not found"
    exit 1
fi

# Get PostgreSQL credentials
POSTGRES_USER=$(get_service_config "$SERVICE_NAME" | grep -o '"user":"[^"]*"' | cut -d'"' -f4)
POSTGRES_DB=$(get_service_config "$SERVICE_NAME" | grep -o '"database":"[^"]*"' | cut -d'"' -f4)

echo "-----> Restoring database from $BACKUP_FILE"

# Restore database
cat "$BACKUP_FILE" | docker exec -i "$SERVICE_NAME" psql -U "$POSTGRES_USER" "$POSTGRES_DB"

echo "-----> Database restored successfully"

